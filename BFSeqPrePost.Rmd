---
title: "Sequential Bayes factor trial design for Gaussian pre-post outcomes"
author:
  - name: Andr√© Moser, CTU Bern, University of Bern
    orcid_id: 0000-0001-7178-6539
output: 
  distill::distill_article:
    toc: true
    number_sections: true    
    toc_float: true
bibliography: BFSeqPrePost.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

The article of @Gajewski2022 discusses a two-stage two-endpoint adaptive Bayesian trial design with a continuous primary endpoint and one secondary endpoint. The novelty of the presented study is that the authors specify rules for early stopping for efficacy or futility based on the posterior distribution for both endpoints jointly with the aim that the analysis for the secondary endpoint has enough information: *"Specifically, we are interested in a trial design that tests success of a single primary endpoint (rank) but with the desire to stop the trial only if the single, key secondary endpoint also has adequate information"* (@Gajewski2022). One limitation of the study from @Gajewski2022 is that the endpoints were defined as the difference between a post-intervention measurement and a pre-intervention measurement. Because of the potential correlation between both measurements there might exist a regression to the mean effect, see for example @Vickers1123. 

@Schonbrodt2018 proposed sequential Bayes factor designs as an alternative to the classic power analysis (Bayesian or Frequentist), which rely on prior guesses of effect sizes and decision cut-offs (for example, cut-offs for posterior predictive distributions or type-I error). The Bayes factor is a compelling alternative to the above mentioned design parameters and allows for sequential update in a trial design. @Schonbrodt2017 defined a sequential Bayes factor (SBF) as a Bayes factor which is computed in a sequential setting until an a priori defined level of evidence is reached. SNF designs As discussed in @Schonbrodt2018, also SBF designs have its limitations but extends common guidelines for power calculations with an index of evidence which is appealing for prospective design analysis.

In the current study we use a sequential Bayes factor design for bivariate Gaussian endpoints to investigate operation characteristics of the implemented trial design and compare it to a fixed-n Bayes factor design, a Bayesian design with early stopping rules for efficacy/futility based on posterior predictive distributions and frequentist operation characteristics.

# Supplement

## ANCOVA example analysis

@Vickers1123 provide the rationale for an ANCOVA analysis. As illustrative example we consider a situation where pre-intervention and post-intervention measurements are drawn from a bivariate normal distribution for each group separately. For group 0 we assume that before the intervention the measurements have a mean value of $0$ and after the intervention a mean value of $0.5$. The standard deviations for both time points are equal to $1$ and the correlation between the time points is $-0.75$, that is,
\[
\mu_0=(0, 0.5)^{\top}, \quad \Sigma_0=\begin{pmatrix} 1 & -0.75 \\ -0.75 & 1\end{pmatrix},
\]
where $\Sigma_0$ denotes the covariance matrix.

For group 1 we assume
\[
\mu_1=(0, -0.5)^{\top}, \quad \Sigma_1=\begin{pmatrix} 1 & 0.5 \\ 0.5 & 1\end{pmatrix}.
\]

An ANCOVA model uses a linear regression with the post-intervention measurements as outcome, group allocation as predictor and adjusts for pre-intervention measurements.

```{r, results='markup', echo=T, fig.height=8.6, fig.width=7.4}
library(mvtnorm)
library(tidyverse)

# Seed
set.seed(1)

# Sample size
n <- 100

# Parameters group 0
mu_t0 <- 0
mu_t1 <- 0.5
sd_t0 <- 1
sd_t1 <- 1
cor_t0_t1 <- -0.75

cov_mat <- matrix(c(sd_t0^2, sd_t0*sd_t1*cor_t0_t1, 
                    sd_t0*sd_t1*cor_t0_t1, sd_t1^2), ncol=2)
y_0 <- rmvnorm(n, mean=c(mu_t0, mu_t1), sigma=cov_mat)

# Parameters group 1
mu_t0 <- 0
mu_t1 <- -0.5
sd_t0 <- 1
sd_t1 <- 1
cor_t0_t1 <- 0.5

cov_mat <- matrix(c(sd_t0^2, sd_t0*sd_t1*cor_t0_t1, 
                    sd_t0*sd_t1*cor_t0_t1, sd_t1^2), ncol=2)
y_1 <- rmvnorm(n, mean=c(mu_t0, mu_t1), sigma=cov_mat)

# Data preperation
data0 <- data.frame(y_0=y_0[,1], y_1=y_0[,2], group=0)
data1 <- data.frame(y_0=y_1[,1], y_1=y_1[,2], group=1)
data <- bind_rows(data0, data1)

# ANCOVA model
mod <- lm(y_1 ~ group*y_0, data=data)
summary(mod)$coeff[,1:2]
```

Since the pre-intervention and post-intervention measurements are standardized (that is, centered and expressed per 1 standard deviation increase), the ```y_0``` coefficient (`r round(summary(mod)$coeff[3,1], 2)`) represents the estimated correlation in group 0, while the sum of the coefficient ```y_0``` (`r round(summary(mod)$coeff[3,1], 2)`) and the interaction term ```group:y_0``` (`r round(summary(mod)$coeff[4,1], 2)`) is the estimated correlation in group 1 (`r round(summary(mod)$coeff[3,1]+summary(mod)$coeff[4,1], 2)`). For us of interest is only the group allocation effect represented by the coefficient ```group```. Here, group 1 has an estimated `r round(abs(summary(mod)$coeff[2,1]), 2)` lower post-intervention measurement compared to group 0 (true value equals $-1$).
