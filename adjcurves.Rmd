---
title: "Adjusted survival curves"
author:
  - name: Andr√© Moser, CTU Bern, University of Bern
    orcid_id: 0000-0001-7178-6539
site: distill::distill_website
bibliography: adjcurves.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Background

Unadjusted Kaplan-Meier curves from observational data might be biased because of confounding (@COLE200445). This vignette introduces the concept of inverse probability (IP) weighted survival curves.

# Example

We consider a study population of 10,000 patients who receive a medication. 60% of the patients are women. 30% of the patients have a specific measures enzym. Those with the enzym were more likely to receive the medication (with a probability of 75%), compared to those without the enyzm (probability of 50%).

- Research question: What is the effect of the medication on death?
- Study design: Cohort study
- Outcome of interest: Time to death or end of follow-up
- Predictor of interest: Medication
- Confounders: Sex, enzym

# Analysis strategy

IP weighting constructs weights which are equal to the probability of an individual's treatment (here: receiving the medication) given observed covariates (here: sex and enzym) and creates pseudopopulations in which observed covariates are independent of treatment (i.e. no confounding) (@hernan_book).

```{r, echo=F}
main.path <- "/Users/am20q919/Clinical studies/Lectures/JournalClub"
```

```{r, echo=F, message=F, warning=F}
library(tidyverse)
library(haven)
library(Hmisc)
library(survey)
library(survival)
library(kableExtra)
library(gtsummary)
library(rms)
library(survminer)
```

```{r, echo=F, message=F, warning=F, results='asis'}
set.seed(1)
n <- 10000

# 60% percent women
female <- rbinom(n, 1, 0.6)
# Men has the enzym with a prob of 0.3; women have
# a 5 times higher chance of having the enzym
enzym <- ifelse(runif(n) < plogis(qlogis(0.3)+log(5)*female), 1, 0)
# Those with enzym receive medication with prob 0.75
medi <- ifelse(runif(n) < plogis(log(3)*enzym), 1, 0)
# Hazard of dying: HR=10 of those with enyzm; HR of 1 for medication
haz <- 0.01*exp(log(10)*enzym)
# Time to death
time_to_death <- -log(runif(n))/haz
# Censoring time: Mean duration 20 days
censored <- rweibull(n, 1, 20)
# Follow-up time
fup <- pmin(time_to_death, censored)
# Death
death <- ifelse(time_to_death<=censored, 1, 0)
# Data
data <- data.frame(fup, death, medi, enzym, female)
```

## Descriptive table

```{r, echo=F, message=F, warning=F, results='asis'}
data %>% tbl_summary(by=medi, label=list(medi ~ "Medication")) 
```

## Unadjusted Kaplan-Meier curve

```{r, echo=T, message=F, warning=F}
mod <- survfit(Surv(fup, death)~medi, data=data)
ggsurvplot(mod, data=data, palette=c("#CC0000", "black"), censor=F)
```

## Cox modelling

```{r, echo=T, message=F, warning=F}
coxph(Surv(fup, death) ~ medi, data = data)

coxph(Surv(fup, death) ~ medi+enzym, data = data)
```


## IPW modelling

```{r, echo=T, message=F, warning=F, results='markup'}
# IPW denominator
mod <- glm(medi ~ female+enzym, data=data, family=binomial())
summary(mod)

data$ipw <- NA
# Probabilty of treatment
data$ipw <- predict(mod, data=data, type="response")
# Probabilty of non-treatment
data$ipw[data$medi==0] <- 1-predict(mod, data=data, type="response")[data$medi==0]

# Stabilized weights
mod0 <- glm(medi ~ 1, data=data, family=binomial())
data$ipw0 <- predict(mod0, data=data, type="response")
data$ipw0[data$medi==0] <- 1-predict(mod0, data=data, type="response")[data$medi==0]
data$ipw <- data$ipw0/data$ipw

svy_design <- svydesign(id=~1, weights=~ipw, data=data)
```



```{r, echo=T, message=F, warning=F, results='markup'}
# IPW adjusted Kaplan-Meier
km_fit <- svykm(Surv(fup, death) ~ medi, design=svy_design)

km_df <- data.frame(time=km_fit$`1`$time, surv=km_fit$`1`$surv, strata="medi=1")
km_df <- bind_rows(km_df, data.frame(time=km_fit$`0`$time, surv=km_fit$`0`$surv, strata="medi=0"))
ggsurvplot_df(km_df, palette=c("#CC0000", "black"), censor=F)
```

```{r, echo=T, message=F, warning=F, results='markup'}
mod <- svycoxph(Surv(fup, death) ~ medi, design=svy_design)
summary(mod)
```

# Data simulation

```{r, echo=T, message=F, warning=F, results='asis'}
set.seed(1)
n <- 10000

# 60% percent women
female <- rbinom(n, 1, 0.6)
# Men has the enzym with a prob of 0.3; women have
# a 5 times higher chance of having the enzym
enzym <- ifelse(runif(n) < plogis(qlogis(0.3)+log(5)*female), 1, 0)
# Those with enzym receive medication with prob 0.75
medi <- ifelse(runif(n) < plogis(log(3)*enzym), 1, 0)
# Hazard of dying: HR=10 of those with enyzm; HR of 1 for medication
haz <- 0.01*exp(log(10)*enzym)
# Time to death
time_to_death <- -log(runif(n))/haz
# Censoring time: Mean duration 20 days
censored <- rweibull(n, 1, 20)
# Follow-up time
fup <- pmin(time_to_death, censored)
# Death
death <- ifelse(time_to_death<=censored, 1, 0)
# Data
data <- data.frame(fup, death, medi, enzym, female)
```

